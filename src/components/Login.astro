---
// src/components/Login.astro
---
<section class="min-h-screen flex items-center justify-center bg-gradient-to-b from-[#0f1724] to-[#071023] p-8 box-border">
    <form id="login-form" class="w-full max-w-sm bg-gradient-to-b from-[rgba(255,255,255,0.02)] to-[rgba(0,0,0,0.02)] border border-[rgba(255,255,255,0.04)] p-8 rounded-xl text-slate-100 shadow-lg box-border" novalidate>
        <h1 class="m-0 mb-4 text-center text-lg font-semibold">Iniciar sesión</h1>

        <div class="flex flex-col gap-1.5 mb-3.5">
            <label for="username" class="text-sm text-slate-400">Usuario</label>
            <input id="username" name="username" type="text" autocomplete="username" required
                class="p-3 rounded-lg border border-[rgba(255,255,255,0.06)] bg-[rgba(255,255,255,0.02)] text-slate-100 text-sm outline-none transition-shadow transition-colors focus:border-sky-400 focus:ring-4 focus:ring-sky-300/10" />
        </div>

        <div class="flex flex-col gap-1.5 mb-3.5">
            <label for="password" class="text-sm text-slate-400">Contraseña</label>
            <input id="password" name="password" type="password" autocomplete="current-password" required
                class="p-3 rounded-lg border border-[rgba(255,255,255,0.06)] bg-[rgba(255,255,255,0.02)] text-slate-100 text-sm outline-none transition-shadow transition-colors focus:border-sky-400 focus:ring-4 focus:ring-sky-300/10" />
        </div>

        <button type="submit" class="w-full py-3 mt-1 bg-gradient-to-r from-sky-400 to-sky-600 text-white border-0 rounded-lg font-semibold active:translate-y-[1px]">
            Entrar
        </button>

        <p id="msg" class="mt-3 text-center text-slate-400 min-h-[1.2rem]" aria-live="polite"></p>
    </form>
</section>

<script type="module">
    const form = document.getElementById('login-form');
    const msg = document.getElementById('msg');
    const API_URL = 'http://localhost:3000/api';

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        msg.textContent = '';
        msg.classList.remove('text-green-300', 'text-red-400');
        msg.classList.add('text-slate-400');

        const username = form.username.value.trim();
        const password = form.password.value;

        if (!username || !password) {
            msg.textContent = 'Por favor completa usuario y contraseña.';
            msg.classList.add('text-red-400');
            return;
        }

        msg.textContent = 'Verificando...';

        try {
            const response = await fetch(`${API_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ username, password }),
            });

            const data = await response.json();

            if (response.ok && data.success && data.token) {
                console.log('[LOGIN] ✓ Login exitoso');
                console.log('[LOGIN] Token recibido:', data.token.substring(0, 30) + '...');
                
                // Guardar en localStorage
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('adminUser', username);
                
                // VERIFICAR que se guardó
                const verificar = localStorage.getItem('authToken');
                console.log('[LOGIN] Token guardado en localStorage?', !!verificar);
                console.log('[LOGIN] Token guardado:', verificar ? verificar.substring(0, 30) + '...' : 'NULL');
                
                if (!verificar) {
                    msg.textContent = 'ERROR: No se pudo guardar el token en localStorage';
                    msg.classList.add('text-red-400');
                    console.error('[LOGIN] ❌ localStorage.setItem FALLÓ');
                    return;
                }
                
                msg.textContent = 'Acceso correcto. Redirigiendo...';
                msg.classList.remove('text-slate-400');
                msg.classList.add('text-green-300');
                
                console.log('[LOGIN] Redirigiendo a /dashboard con token...');
                setTimeout(() => {
                    console.log('[LOGIN] EJECUTANDO redirect');
                    window.location.href = '/dashboard?token=' + encodeURIComponent(data.token);
                }, 1000);
            } else {
                msg.textContent = data.error || 'Usuario o contraseña incorrectos.';
                msg.classList.remove('text-slate-400');
                msg.classList.add('text-red-400');
            }
        } catch (error) {
            console.error('Error al iniciar sesión:', error);
            msg.textContent = 'Error de conexión con el servidor.';
            msg.classList.remove('text-slate-400');
            msg.classList.add('text-red-400');
        }
    });
</script>
